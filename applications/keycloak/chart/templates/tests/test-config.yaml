{{- if .Values.tests.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ include "keycloak.fullname" . }}-keycloak-test"
  labels:
    {{ include "keycloak.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
data:
  test.sh: |-

    # This test checks if the fiware-server Realm is configured as well as users and groups.
    set -e
    # Check if the Realm is present
    curl {{ include "keycloak.fullname" . }}.{{ .Release.Namespace }}.svc/realms/fiware-server \
                -H 'Content-Type: application/json' \
                -H "Accept: application/json"
                
    TOKEN=curl {{ include "keycloak.fullname" . }}.{{ .Release.Namespace }}.svc/realms/fiware-server/protocol/openid-connect/token \
        -X POST \
        -H 'Accept: application/json' \
        -H 'Content-Type: application/x-www-form-urlencoded' \
        -H 'cache-control: no-cache' \
        -d grant_type=password \
        -d username=admin-user \
        -d password=admin-user \
        -d client_id=orion-pep \
        -d client_secret=978ad148-d99b-406d-83fc-578597290a79 \
        | sed 's/{"access_token":"\(.*\)","expires_in"\(.*\)/\1/'

    echo $TOKEN

    # # get all users of gateway realm, use the token from above and use Bearer as prefix
    # curl -X GET \
    #   https://<HOST>/auth/admin/realms/gateway/users \
    #     -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkI...' \
    #     -H 'cache-control: no-cache'

    # # Get Timescale Datasource
    # curl {{ include "keycloak.fullname" . }}.{{ .Release.Namespace }}.svc/api/datasources/name/timescale-datasource \
    #             -H 'Content-Type: application/json' \
    #             -H "Accept: application/json"


    # # Check Dashboards
    # curl {{ include "keycloak.fullname" $ }}.{{ $.Release.Namespace }}.svc/api/dashboards/uid/{{ base $path | replace ".json" ""}} \
    #             -H 'Content-Type: application/json' \
    #             -H "Accept: application/json"

    sleep 30 

{{- end}}
